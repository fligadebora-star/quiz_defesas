// quiz.js

// Configuração do desconto
const DISCOUNT_ENABLED = true;          // coloca false para retirar
const DISCOUNT_PERCENT = 10;
const DISCOUNT_CODE = "DEFESAS10";
const DISCOUNT_MIN_SCORE = 20;          // nº de respostas certas

// Perguntas para público geral
const questions = [
  {
    text: "Qual é a barreira de defesa que entra primeiro em contacto com vírus e bactérias do dia a dia?",
    options: [
      "A pele e as mucosas (nariz, boca, olhos)",
      "O coração",
      "Os músculos",
      "Os rins"
    ],
    correctIndex: 0,
    feedbackCorrect: "A pele e as mucosas são a primeira barreira física de proteção do organismo contra agentes externos.",
    feedbackWrong: "A pele e as mucosas (nariz, boca, olhos) são a primeira barreira de defesa do corpo.",
    supplementTip: "Manter a pele e mucosas saudáveis depende de uma boa hidratação, alimentação equilibrada e sono adequado.",
    productLink: ""
  },
  {
    text: "Qual destas vitaminas é mais conhecida por ajudar o sistema imunitário a funcionar normalmente?",
    options: [
      "Vitamina C",
      "Vitamina K",
      "Vitamina B12",
      "Vitamina A apenas"
    ],
    correctIndex: 0,
    feedbackCorrect: "A vitamina C contribui para o normal funcionamento do sistema imunitário e tem ação antioxidante.",
    feedbackWrong: "A vitamina C é a mais associada ao suporte do sistema imunitário no dia a dia.",
    supplementTip: "Pode ser obtida pela alimentação (fruta e legumes) ou através de suplementos quando necessário.",
    productLink: ""
  },
  {
    text: "Em que altura do ano as pessoas mais procuram suplementos para as defesas?",
    options: [
      "Sobretudo no outono e inverno",
      "Só no verão",
      "Apenas na primavera",
      "Nunca é preciso"
    ],
    correctIndex: 0,
    feedbackCorrect: "No outono e inverno aumentam as infeções respiratórias, por isso é frequente reforçar as defesas nesta fase.",
    feedbackWrong: "É mais comum reforçar as defesas no outono e inverno, quando as infeções respiratórias aumentam.",
    supplementTip: "Pergunte na farmácia quais os suplementos mais adequados ao seu caso nesta altura do ano.",
    productLink: ""
  },
  {
    text: "Qual destes nutrientes é importante para o funcionamento normal do sistema imunitário?",
    options: [
      "Zinco",
      "Açúcar",
      "Sal",
      "Cafeína"
    ],
    correctIndex: 0,
    feedbackCorrect: "O zinco contribui para o normal funcionamento do sistema imunitário e para a proteção das células contra oxidações indesejáveis.",
    feedbackWrong: "O zinco é um mineral chave para o sistema imunitário.",
    supplementTip: "Existem suplementos específicos de zinco ou fórmulas que o associam a vitamina C e vitamina D.",
    productLink: ""
  },
  {
    text: "Qual destes hábitos mais enfraquece as defesas do organismo?",
    options: [
      "Dormir poucas horas e com má qualidade de sono",
      "Beber água ao longo do dia",
      "Fazer exercício físico moderado",
      "Ter uma alimentação variada"
    ],
    correctIndex: 0,
    feedbackCorrect: "O sono insuficiente está associado a maior risco de infeções e recuperação mais lenta.",
    feedbackWrong: "Dormir poucas horas de forma prolongada enfraquece o sistema imunitário.",
    supplementTip: "Higiene do sono e gestão do stress são tão importantes quanto os suplementos.",
    productLink: ""
  },
  {
    text: "Um suplemento para as defesas deve substituir uma alimentação equilibrada?",
    options: [
      "Não, deve ser um complemento",
      "Sim, basta tomar o suplemento",
      "Sim, se for \"natural\"",
      "Sim, se for em cápsulas"
    ],
    correctIndex: 0,
    feedbackCorrect: "Os suplementos são um complemento e não substituem uma alimentação variada e equilibrada.",
    feedbackWrong: "Os suplementos não substituem uma boa alimentação, apenas complementam quando necessário.",
    supplementTip: "Em caso de dúvida, peça aconselhamento na farmácia sobre o que faz sentido para si.",
    productLink: ""
  },
  {
    text: "A vitamina D está ligada a que função, para além da saúde óssea?",
    options: [
      "Contribui para o normal funcionamento do sistema imunitário",
      "Serve apenas para ter mais energia imediata",
      "Serve apenas para emagrecer",
      "Não tem qualquer relação com as defesas"
    ],
    correctIndex: 0,
    feedbackCorrect: "A vitamina D contribui para o normal funcionamento do sistema imunitário.",
    feedbackWrong: "Para além da saúde óssea, a vitamina D também apoia o sistema imunitário.",
    supplementTip: "Em alguns casos, pode ser necessário suplementar vitamina D após avaliação clínica.",
    productLink: ""
  },
  {
    text: "Probióticos podem ter interesse na imunidade porque:",
    options: [
      "Ajudam a equilibrar a flora intestinal, ligada às defesas",
      "Substituem todas as vacinas",
      "Curam qualquer infeção em poucas horas",
      "Servem apenas para emagrecer"
    ],
    correctIndex: 0,
    feedbackCorrect: "Grande parte do sistema imunitário está ligada ao intestino, por isso o equilíbrio da microbiota é importante.",
    feedbackWrong: "Probióticos ajudam a equilibrar a flora intestinal, que está relacionada com a imunidade.",
    supplementTip: "Podem ser úteis em situações específicas, mas devem ser escolhidos de acordo com a necessidade.",
    productLink: ""
  },
  {
    text: "Qual destes grupos deve ter especial cuidado antes de tomar suplementos para as defesas por iniciativa própria?",
    options: [
      "Grávidas, pessoas com doenças crónicas e quem toma vários medicamentos",
      "Adultos saudáveis sem qualquer patologia",
      "Quem bebe muito café",
      "Quem faz exercício físico"
    ],
    correctIndex: 0,
    feedbackCorrect: "Grávidas, doentes crónicos e polimedicados devem ter sempre avaliação profissional antes de iniciar suplementos.",
    feedbackWrong: "Grávidas, pessoas com doenças crónicas e quem toma vários medicamentos precisam de aconselhamento individual.",
    supplementTip: "Peça sempre ajuda ao seu farmacêutico ou médico nestas situações.",
    productLink: ""
  },
  {
    text: "Quando começa a pensar em reforçar as defesas, o que deve ser sempre a primeira base?",
    options: [
      "Sono, alimentação e estilo de vida saudáveis",
      "Aumentar o consumo de açúcar",
      "Evitar toda a fruta",
      "Tomar o máximo de suplementos possíveis"
    ],
    correctIndex: 0,
    feedbackCorrect: "O estilo de vida saudável é sempre a base, sobre a qual os suplementos podem atuar como complemento.",
    feedbackWrong: "A base para defesas fortes é sono, alimentação equilibrada e hábitos saudáveis.",
    supplementTip: "Um suplemento faz mais sentido quando o estilo de vida também é trabalhado.",
    productLink: ""
  }
];

// Lógica do quiz
let currentIndex = 0;
let score = 0;
let answered = false;

const questionText = document.getElementById("questionText");
const optionsList = document.getElementById("optionsList");
const feedbackBox = document.getElementById("feedbackBox");
const feedbackText = document.getElementById("feedbackText");
const questionCounter = document.getElementById("questionCounter");
const progressFill = document.getElementById("progressFill");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");

const quizCard = document.getElementById("quizCard");
const resultScreen = document.getElementById("resultScreen");
const scoreText = document.getElementById("scoreText");
const scoreDetail = document.getElementById("scoreDetail");
const discountBox = document.getElementById("discountBox");
const discountText = document.getElementById("discountText");
const restartBtn = document.getElementById("restartBtn");

renderQuestion();

function renderQuestion() {
  const q = questions[currentIndex];
  answered = false;
  nextBtn.disabled = true;

  questionCounter.textContent = `Pergunta ${currentIndex + 1} de ${questions.length}`;
  const percent = (currentIndex / questions.length) * 100;
  progressFill.style.width = `${percent}%`;

  questionText.textContent = q.text;

  optionsList.innerHTML = "";
  q.options.forEach((opt, idx) => {
    const li = document.createElement("li");
    li.className = "quiz-option";
    li.dataset.index = idx;

    const bullet = document.createElement("span");
    bullet.className = "bullet";
    bullet.textContent = String.fromCharCode(65 + idx);

    const text = document.createElement("span");
    text.textContent = opt;

    li.appendChild(bullet);
    li.appendChild(text);
    li.addEventListener("click", () => handleAnswer(idx));

    optionsList.appendChild(li);
  });

  feedbackBox.classList.remove("correct", "incorrect");
  feedbackText.textContent = "Escolha uma opção para ver se acertou.";

  prevBtn.disabled = currentIndex === 0;
}

function handleAnswer(selectedIndex) {
  if (answered) return;

  const q = questions[currentIndex];
  const options = optionsList.querySelectorAll(".quiz-option");

  answered = true;
  nextBtn.disabled = false;

  options.forEach((opt) => {
    opt.classList.remove("selected", "correct", "incorrect");
  });

  const selectedLi = options[selectedIndex];
  selectedLi.classList.add("selected");

  const isCorrect = selectedIndex === q.correctIndex;

  if (isCorrect) {
    score++;
    selectedLi.classList.add("correct");
    feedbackBox.classList.remove("incorrect");
    feedbackBox.classList.add("correct");
    feedbackText.textContent = q.feedbackCorrect + " " + q.supplementTip;
  } else {
    selectedLi.classList.add("incorrect");
    const correctLi = options[q.correctIndex];
    correctLi.classList.add("correct");
    feedbackBox.classList.remove("correct");
    feedbackBox.classList.add("incorrect");
    feedbackText.textContent = q.feedbackWrong + " " + q.supplementTip;
  }
}

nextBtn.addEventListener("click", () => {
  if (!answered) return;

  if (currentIndex < questions.length - 1) {
    currentIndex++;
    renderQuestion();
  } else {
    showResult();
  }
});

prevBtn.addEventListener("click", () => {
  if (currentIndex > 0) {
    currentIndex--;
    renderQuestion();
  }
});

restartBtn.addEventListener("click", () => {
  currentIndex = 0;
  score = 0;
  quizCard.classList.remove("hidden");
  resultScreen.classList.add("hidden");
  renderQuestion();
});

function showResult() {
  quizCard.classList.add("hidden");
  resultScreen.classList.remove("hidden");

  scoreText.textContent = `Acertou ${score} em ${questions.length} perguntas.`;
  const percent = Math.round((score / questions.length) * 100);
  scoreDetail.textContent = `Pontuação: ${percent}%.`;

  if (DISCOUNT_ENABLED && score >= DISCOUNT_MIN_SCORE) {
    discountBox.classList.remove("hidden");
    discountText.innerHTML =
      `Como acertou todas as perguntas, desbloqueou um vale de ${DISCOUNT_PERCENT}% em compras selecionadas na nossa farmácia.<br><br>` +
      `Use o código <strong>${DISCOUNT_CODE}</strong> ao finalizar a compra em ` +
      `<a href="https://www.farmaciadaliga.pt" target="_blank" rel="noopener noreferrer">www.farmaciadaliga.pt</a>.`;
  } else {
    discountBox.classList.add("hidden");
  }
}